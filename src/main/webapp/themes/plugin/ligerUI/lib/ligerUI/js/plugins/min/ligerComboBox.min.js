(function(e){e.fn.ligerComboBox=function(t){return e.ligerui.run.call(this,"ligerComboBox",arguments)},e.fn.ligerGetComboBoxManager=function(){return e.ligerui.run.call(this,"ligerGetComboBoxManager",arguments)},e.ligerDefaults.ComboBox={resize:!0,isMultiSelect:!1,isShowCheckBox:!1,columns:!1,selectBoxWidth:!1,selectBoxHeight:!1,onBeforeSelect:!1,onSelected:null,initValue:null,initText:null,valueField:"id",textField:"text",valueFieldID:null,slide:!0,split:";",data:null,tree:null,treeLeafOnly:!0,grid:null,onStartResize:null,onEndResize:null,hideOnLoseFocus:!0,url:null,onSuccess:null,onError:null,onBeforeOpen:null,render:null,absolute:!0},e.ligerMethos.ComboBox=e.ligerMethos.ComboBox||{},e.ligerui.controls.ComboBox=function(t,n){e.ligerui.controls.ComboBox.base.constructor.call(this,t,n)},e.ligerui.controls.ComboBox.ligerExtend(e.ligerui.controls.Input,{__getType:function(){return"ComboBox"},_extendMethods:function(){return e.ligerMethos.ComboBox},_init:function(){e.ligerui.controls.ComboBox.base._init.call(this);var t=this.options;t.columns&&(t.isShowCheckBox=!0),t.isMultiSelect&&(t.isShowCheckBox=!0)},_render:function(){var t=this,n=this.options;t.data=n.data,t.inputText=null,t.select=null,t.textFieldID="",t.valueFieldID="",t.valueField=null;if(this.element.tagName.toLowerCase()=="input")this.element.readOnly=!0,t.inputText=e(this.element),t.textFieldID=this.element.id;else{if(this.element.tagName.toLowerCase()!="select")return;e(this.element).hide(),t.select=e(this.element),n.isMultiSelect=!1,n.isShowCheckBox=!1,t.textFieldID=this.element.id+"_txt",t.inputText=e('<input type="text" readonly="true"/>'),t.inputText.attr("id",t.textFieldID).insertAfter(e(this.element))}t.inputText[0].name==undefined&&(t.inputText[0].name=t.textFieldID),t.valueField=null,n.valueFieldID?(t.valueField=e("#"+n.valueFieldID+":input"),t.valueField.length==0&&(t.valueField=e('<input type="hidden"/>')),t.valueField[0].id=t.valueField[0].name=n.valueFieldID):(t.valueField=e('<input type="hidden"/>'),t.valueField[0].id=t.valueField[0].name=t.textFieldID+"_val"),t.valueField[0].name==undefined&&(t.valueField[0].name=t.valueField[0].id),t.link=e('<div class="l-trigger"><div class="l-trigger-icon"></div></div>'),t.selectBox=e('<div class="l-box-select"><div class="l-box-select-inner"><table cellpadding="0" cellspacing="0" border="0" class="l-box-select-table"></table></div></div>'),t.selectBox.table=e("table:first",t.selectBox),t.wrapper=t.inputText.wrap('<div class="l-text l-text-combobox"></div>').parent(),t.wrapper.append('<div class="l-text-l"></div><div class="l-text-r"></div>'),t.wrapper.append(t.link),t.textwrapper=t.wrapper.wrap('<div class="l-text-wrapper"></div>').parent(),n.absolute?t.selectBox.appendTo("body").addClass("l-box-select-absolute"):t.textwrapper.append(t.selectBox),t.textwrapper.append(t.valueField),t.inputText.addClass("l-text-field"),n.isShowCheckBox&&!t.select?e("table",t.selectBox).addClass("l-table-checkbox"):(n.isShowCheckBox=!1,e("table",t.selectBox).addClass("l-table-nocheckbox")),t.link.hover(function(){if(n.disabled)return;this.className="l-trigger-hover"},function(){if(n.disabled)return;this.className="l-trigger"}).mousedown(function(){if(n.disabled)return;this.className="l-trigger-pressed"}).mouseup(function(){if(n.disabled)return;this.className="l-trigger-hover"}).click(function(){if(n.disabled)return;if(t.trigger("beforeOpen")==0)return!1;t._toggleSelectBox(t.selectBox.is(":visible"))}),t.inputText.click(function(){if(n.disabled)return;if(t.trigger("beforeOpen")==0)return!1;t._toggleSelectBox(t.selectBox.is(":visible"))}).blur(function(){if(n.disabled)return;t.wrapper.removeClass("l-text-focus")}).focus(function(){if(n.disabled)return;t.wrapper.addClass("l-text-focus")}),t.wrapper.hover(function(){if(n.disabled)return;t.wrapper.addClass("l-text-over")},function(){if(n.disabled)return;t.wrapper.removeClass("l-text-over")}),t.resizing=!1,t.selectBox.hover(null,function(e){n.hideOnLoseFocus&&t.selectBox.is(":visible")&&!t.boxToggling&&!t.resizing&&t._toggleSelectBox(!0)});var r=e("tr",t.selectBox.table).length;!n.selectBoxHeight&&r<8&&(n.selectBoxHeight=r*30),n.selectBoxHeight&&t.selectBox.height(n.selectBoxHeight),t.bulidContent(),t.set(n),n.selectBoxWidth?t.selectBox.width(n.selectBoxWidth):t.selectBox.css("width",t.wrapper.css("width"))},destroy:function(){this.wrapper&&this.wrapper.remove(),this.selectBox&&this.selectBox.remove(),this.options=null,e.ligerui.remove(this)},_setDisabled:function(e){e?this.wrapper.addClass("l-text-disabled"):this.wrapper.removeClass("l-text-disabled")},_setLable:function(t){var n=this,r=this.options;t&&(n.labelwrapper?n.labelwrapper.find(".l-text-label:first").html(t+":&nbsp"):(n.labelwrapper=n.textwrapper.wrap('<div class="l-labeltext"></div>').parent(),n.labelwrapper.prepend('<div class="l-text-label" style="float:left;display:inline;">'+t+":&nbsp</div>"),n.textwrapper.css("float","left")),r.labelWidth?e(".l-text-label",n.labelwrapper).outerWidth(r.labelWidth):r.labelWidth=e(".l-text-label",n.labelwrapper).outerWidth(),e(".l-text-label",n.labelwrapper).width(r.labelWidth),e(".l-text-label",n.labelwrapper).height(n.wrapper.height()),n.labelwrapper.append('<br style="clear:both;" />'),r.labelAlign&&e(".l-text-label",n.labelwrapper).css("text-align",r.labelAlign),n.textwrapper.css({display:"inline"}),n.labelwrapper.width(n.wrapper.outerWidth()+r.labelWidth+2))},_setWidth:function(e){var t=this;e>20&&(t.wrapper.css({width:e}),t.inputText.css({width:e-20}),t.textwrapper.css({width:e}))},_setHeight:function(e){var t=this;e>10&&(t.wrapper.height(e),t.inputText.height(e-2),t.link.height(e-4),t.textwrapper.css({width:e}))},_setResize:function(t){if(t&&e.fn.ligerResizable){var n=this;n.selectBox.ligerResizable({handles:"se,s,e",onStartResize:function(){n.resizing=!0,n.trigger("startResize")},onEndResize:function(){n.resizing=!1;if(n.trigger("endResize")==0)return!1}}),n.selectBox.append("<div class='l-btn-nw-drop'></div>")}},findTextByValue:function(t){var n=this,r=this.options;if(t==undefined)return"";var i="",s=function(e){var n=t.toString().split(r.split);for(var i=0;i<n.length;i++)if(n[i]==e)return!0;return!1};return e(n.data).each(function(e,t){var n=t[r.valueField],o=t[r.textField];s(n)&&(i+=o+r.split)}),i.length>0&&(i=i.substr(0,i.length-1)),i},findValueByText:function(t){var n=this,r=this.options;if(!t&&t=="")return"";var i=function(e){var n=t.toString().split(r.split);for(var i=0;i<n.length;i++)if(n[i]==e)return!0;return!1},s="";return e(n.data).each(function(e,t){var n=t[r.valueField],o=t[r.textField];i(o)&&(s+=n+r.split)}),s.length>0&&(s=s.substr(0,s.length-1)),s},removeItem:function(){},insertItem:function(){},addItem:function(){},_setValue:function(t){var n=this,r=this.options,i=n.findTextByValue(t);if(r.tree)n.selectValueByTree(t);else if(!r.isMultiSelect)n._changeValue(t,i),e("tr[value="+t+"] td",n.selectBox).addClass("l-selected"),e("tr[value!="+t+"] td",n.selectBox).removeClass("l-selected");else{n._changeValue(t,i);var s=t.toString().split(r.split);e("table.l-table-checkbox :checkbox",n.selectBox).each(function(){this.checked=!1});for(var o=0;o<s.length;o++)e("table.l-table-checkbox tr[value="+s[o]+"] :checkbox",n.selectBox).each(function(){this.checked=!0})}},selectValue:function(e){this._setValue(e)},bulidContent:function(){var t=this,n=this.options;this.clearContent(),t.select?t.setSelect():t.data?t.setData(t.data):n.tree?t.setTree(n.tree):n.grid?t.setGrid(n.grid):n.url&&e.ajax({type:"post",url:n.url,cache:!1,dataType:"json",success:function(e){t.data=e,t.setData(t.data),t.trigger("success",[t.data])},error:function(e,n){t.trigger("error",[e,n])}})},clearContent:function(){var t=this,n=this.options;e("table",t.selectBox).html("")},setSelect:function(){var t=this,n=this.options;this.clearContent(),e("option",t.select).each(function(n){var r=e(this).val(),i=e(this).html(),s=e("<tr><td index='"+n+"' value='"+r+"'>"+i+"</td>");e("table.l-table-nocheckbox",t.selectBox).append(s),e("td",s).hover(function(){e(this).addClass("l-over")},function(){e(this).removeClass("l-over")})}),e("td:eq("+t.select[0].selectedIndex+")",t.selectBox).each(function(){if(e(this).hasClass("l-selected")){t.selectBox.hide();return}e(".l-selected",t.selectBox).removeClass("l-selected"),e(this).addClass("l-selected"),t.select[0].selectedIndex!=e(this).attr("index")&&t.select[0].onchange&&(t.select[0].selectedIndex=e(this).attr("index"),t.select[0].onchange());var r=parseInt(e(this).attr("index"));t.select[0].selectedIndex=r,t.select.trigger("change"),t.selectBox.hide();var i=e(this).attr("value"),s=e(this).html();n.render?t.inputText.val(n.render(i,s)):t.inputText.val(s)}),t._addClickEven()},setData:function(t){var n=this,r=this.options;this.clearContent();if(!t||!t.length)return;n.data!=t&&(n.data=t);if(r.columns){n.selectBox.table.headrow=e("<tr class='l-table-headerow'><td width='18px'></td></tr>"),n.selectBox.table.append(n.selectBox.table.headrow),n.selectBox.table.addClass("l-box-select-grid");for(var i=0;i<r.columns.length;i++){var s=e("<td columnindex='"+i+"' columnname='"+r.columns[i].name+"'>"+r.columns[i].header+"</td>");r.columns[i].width&&s.width(r.columns[i].width),n.selectBox.table.headrow.append(s)}}for(var o=0;o<t.length;o++){var u=t[o][r.valueField],a=t[o][r.textField];if(!r.columns)e("table.l-table-checkbox",n.selectBox).append("<tr value='"+u+"'><td style='width:18px;'  index='"+o+"' value='"+u+"' text='"+a+"' ><input type='checkbox' /></td><td index='"+o+"' value='"+u+"' align='left'>"+a+"</td>"),e("table.l-table-nocheckbox",n.selectBox).append("<tr value='"+u+"'><td index='"+o+"' value='"+u+"' align='left'>"+a+"</td>");else{var f=e("<tr value='"+u+"'><td style='width:18px;'  index='"+o+"' value='"+u+"' text='"+a+"' ><input type='checkbox' /></td></tr>");e("td",n.selectBox.table.headrow).each(function(){var n=e(this).attr("columnname");if(n){var r=e("<td>"+t[o][n]+"</td>");f.append(r)}}),n.selectBox.table.append(f)}}r.isShowCheckBox&&e.fn.ligerCheckBox&&e("table input:checkbox",n.selectBox).ligerCheckBox(),e(".l-table-checkbox input:checkbox",n.selectBox).change(function(){if(this.checked&&n.hasBind("beforeSelect")){var t=null;e(this).parent().get(0).tagName.toLowerCase()=="div"?t=e(this).parent().parent():t=e(this).parent();if(t!=null&&n.trigger("beforeSelect",[t.attr("value"),t.attr("text")])==0)return n.selectBox.slideToggle("fast"),!1}r.isMultiSelect||this.checked&&(e("input:checked",n.selectBox).not(this).each(function(){this.checked=!1,e(".l-checkbox-checked",e(this).parent()).removeClass("l-checkbox-checked")}),n.selectBox.slideToggle("fast")),n._checkboxUpdateValue()}),e("table.l-table-nocheckbox td",n.selectBox).hover(function(){e(this).addClass("l-over")},function(){e(this).removeClass("l-over")}),n._addClickEven(),n._dataInit()},setTree:function(t){var n=this,r=this.options;this.clearContent(),n.selectBox.table.remove(),t.checkbox!=0?t.onCheck=function(){var t=n.treeManager.getChecked(),i=[],s=[];e(t).each(function(e,t){if(r.treeLeafOnly&&t.data.children)return;i.push(t.data[r.valueField]),s.push(t.data[r.textField])}),n._changeValue(i.join(r.split),s.join(r.split))}:(t.onSelect=function(e){if(r.treeLeafOnly&&e.data.children)return;var t=e.data[r.valueField],i=e.data[r.textField];n._changeValue(t,i)},t.onCancelSelect=function(e){n._changeValue("","")}),t.onAfterAppend=function(e,t){if(!n.treeManager)return;var i=null;r.initValue?i=r.initValue:n.valueField.val()!=""&&(i=n.valueField.val()),n.selectValueByTree(i)},n.tree=e("<ul></ul>"),e("div:first",n.selectBox).append(n.tree),n.tree.ligerTree(t),n.treeManager=n.tree.ligerGetTreeManager()},selectValueByTree:function(t){var n=this,r=this.options;if(t!=null){var i="",s=t.toString().split(r.split);e(s).each(function(e,t){n.treeManager.selectNode(t.toString()),i+=n.treeManager.getTextByID(t),e<s.length-1&&(i+=r.split)}),n._changeValue(t,i)}},setGrid:function(t){var n=this,r=this.options;this.clearContent(),n.selectBox.table.remove(),n.grid=e("div:first",n.selectBox),t.columnWidth=t.columnWidth||120,t.width="100%",t.height="100%",t.heightDiff=-2,t.InWindow=!1,n.gridManager=n.grid.ligerGrid(t),r.hideOnLoseFocus=!1;if(t.checkbox!=0){var i=function(){var t=n.gridManager.getCheckedRows(),i=[],s=[];e(t).each(function(e,t){i.push(t[r.valueField]),s.push(t[r.textField])}),n._changeValue(i.join(r.split),s.join(r.split))};n.gridManager.bind("CheckAllRow",i),n.gridManager.bind("CheckRow",i)}else n.gridManager.bind("SelectRow",function(e,t,i){var s=e[r.valueField],o=e[r.textField];n._changeValue(s,o)}),n.gridManager.bind("UnSelectRow",function(e,t,r){n._changeValue("","")});n.bind("show",function(){n.gridManager&&n.gridManager._updateFrozenWidth()}),n.bind("endResize",function(){n.gridManager&&(n.gridManager._updateFrozenWidth(),n.gridManager.setHeight(n.selectBox.height()-2))})},_getValue:function(){return e(this.valueField).val()},getValue:function(){return this._getValue()},updateStyle:function(){var e=this,t=this.options;e._dataInit()},_dataInit:function(){var t=this,n=this.options,r=null;n.initValue!=null&&n.initText!=null&&t._changeValue(n.initValue,n.initText);if(n.initValue!=null){r=n.initValue;if(n.tree)r&&t.selectValueByTree(r);else{var i=t.findTextByValue(r);t._changeValue(r,i)}}else if(n.initText!=null)r=t.findValueByText(n.initText),t._changeValue(r,n.initText);else if(t.valueField.val()!=""){r=t.valueField.val();if(n.tree)r&&t.selectValueByTree(r);else{var i=t.findTextByValue(r);t._changeValue(r,i)}}!n.isShowCheckBox&&r!=null&&e("table tr",t.selectBox).find("td:first").each(function(){r==e(this).attr("value")&&e(this).addClass("l-selected")}),n.isShowCheckBox&&r!=null&&e(":checkbox",t.selectBox).each(function(){var t=null,i=e(this);i.parent().get(0).tagName.toLowerCase()=="div"?t=i.parent().parent():t=i.parent();if(t==null)return;var s=r.toString().split(n.split);e(s).each(function(n,r){r==t.attr("value")&&(e(".l-checkbox",t).addClass("l-checkbox-checked"),i[0].checked=!0)})})},_changeValue:function(e,t){var n=this,r=this.options;n.valueField.val(e),r.render?n.inputText.val(r.render(e,t)):n.inputText.val(t),n.selectedValue=e,n.selectedText=t,n.inputText.trigger("change").focus(),n.trigger("selected",[e,t])},_checkboxUpdateValue:function(){var t=this,n=this.options,r="",i="";e("input:checked",t.selectBox).each(function(){var t=null;e(this).parent().get(0).tagName.toLowerCase()=="div"?t=e(this).parent().parent():t=e(this).parent();if(!t)return;r+=t.attr("value")+n.split,i+=t.attr("text")+n.split}),r.length>0&&(r=r.substr(0,r.length-1)),i.length>0&&(i=i.substr(0,i.length-1)),t._changeValue(r,i)},_addClickEven:function(){var t=this,n=this.options;e(".l-table-nocheckbox td",t.selectBox).click(function(){var r=e(this).attr("value"),i=parseInt(e(this).attr("index")),s=e(this).html();if(t.hasBind("beforeSelect")&&t.trigger("beforeSelect",[r,s])==0)return n.slide?t.selectBox.slideToggle("fast"):t.selectBox.hide(),!1;if(e(this).hasClass("l-selected")){n.slide?t.selectBox.slideToggle("fast"):t.selectBox.hide();return}e(".l-selected",t.selectBox).removeClass("l-selected"),e(this).addClass("l-selected"),t.select&&t.select[0].selectedIndex!=i&&(t.select[0].selectedIndex=i,t.select.trigger("change")),n.slide?(t.boxToggling=!0,t.selectBox.hide("fast",function(){t.boxToggling=!1})):t.selectBox.hide(),t._changeValue(r,s)})},updateSelectBoxPosition:function(){var t=this,n=this.options;if(n.absolute)t.selectBox.css({left:t.wrapper.offset().left,top:t.wrapper.offset().top+1+t.wrapper.outerHeight()});else{var r=t.wrapper.offset().top-e(window).scrollTop(),i=t.selectBox.height()+textHeight+4;r+i>e(window).height()&&r>i&&t.selectBox.css("marginTop",-1*(t.selectBox.height()+textHeight+5))}},_toggleSelectBox:function(t){var n=this,r=this.options,i=n.wrapper.height();n.boxToggling=!0;if(t)r.slide?n.selectBox.slideToggle("fast",function(){n.boxToggling=!1}):(n.selectBox.hide(),n.boxToggling=!1);else{n.updateSelectBoxPosition();if(r.slide)n.selectBox.slideToggle("fast",function(){n.boxToggling=!1;if(!r.isShowCheckBox&&e("td.l-selected",n.selectBox).length>0){var t=e("td.l-selected",n.selectBox).offset().top-n.selectBox.offset().top;e(".l-box-select-inner",n.selectBox).animate({scrollTop:t})}});else{n.selectBox.show(),n.boxToggling=!1;if(!n.tree&&!n.grid&&!r.isShowCheckBox&&e("td.l-selected",n.selectBox).length>0){var s=e("td.l-selected",n.selectBox).offset().top-n.selectBox.offset().top;e(".l-box-select-inner",n.selectBox).animate({scrollTop:s})}}}n.isShowed=n.selectBox.is(":visible"),n.trigger("toggle",[t]),n.trigger(t?"hide":"show")}}),e.ligerui.controls.ComboBox.prototype.setValue=e.ligerui.controls.ComboBox.prototype.selectValue,e.ligerui.controls.ComboBox.prototype.setInputValue=e.ligerui.controls.ComboBox.prototype._changeValue})(jQuery)