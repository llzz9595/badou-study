(function(e){e.fn.ligerFilter=function(){return e.ligerui.run.call(this,"ligerFilter",arguments)},e.fn.ligerGetFilterManager=function(){return e.ligerui.run.call(this,"ligerGetFilterManager",arguments)},e.ligerDefaults.Filter={fields:[],operators:{},editors:{}},e.ligerDefaults.FilterString={strings:{and:"并且",or:"或者",equal:"相等",notequal:"不相等",startwith:"以..开始",endwith:"以..结束",like:"相似",greater:"大于",greaterorequal:"大于或等于",less:"小于",lessorequal:"小于或等于","in":"包括在...",notin:"不包括...",addgroup:"增加分组",addrule:"增加条件",deletegroup:"删除分组"}},e.ligerDefaults.Filter.operators.string=e.ligerDefaults.Filter.operators.text=["equal","notequal","startwith","endwith","like","greater","greaterorequal","less","lessorequal","in","notin"],e.ligerDefaults.Filter.operators.number=e.ligerDefaults.Filter.operators["int"]=e.ligerDefaults.Filter.operators["float"]=e.ligerDefaults.Filter.operators.date=["equal","notequal","greater","greaterorequal","less","lessorequal","in","notin"],e.ligerDefaults.Filter.editors.string={create:function(t,n){var r=e("<input type='text'/>");return t.append(r),r.ligerTextBox(n.editor.options||{}),r},setValue:function(e,t){e.val(t)},getValue:function(e){return e.liger("option","value")},destroy:function(e){e.liger("destroy")}},e.ligerDefaults.Filter.editors.date={create:function(t,n){var r=e("<input type='text'/>");return t.append(r),r.ligerDateEditor(n.editor.options||{}),r},setValue:function(e,t){e.liger("option","value",t)},getValue:function(e,t){return e.liger("option","value")},destroy:function(e){e.liger("destroy")}},e.ligerDefaults.Filter.editors.number={create:function(t,n){var r=e("<input type='text'/>");t.append(r);var i={minValue:n.editor.minValue,maxValue:n.editor.maxValue};return r.ligerSpinner(e.extend(i,n.editor.options||{})),r},setValue:function(e,t){e.val(t)},getValue:function(e,t){var n=t.editor.type=="int";return n?parseInt(e.val(),10):parseFloat(e.val())},destroy:function(e){e.liger("destroy")}},e.ligerDefaults.Filter.editors.combobox={create:function(t,n){var r=e("<input type='text'/>");t.append(r);var i={data:n.data,slide:!1,valueField:n.editor.valueField||n.editor.valueColumnName,textField:n.editor.textField||n.editor.displayColumnName};return e.extend(i,n.editor.options||{}),r.ligerComboBox(i),r},setValue:function(e,t){e.liger("option","value",t)},getValue:function(e){return e.liger("option","value")},destroy:function(e){e.liger("destroy")}},e.ligerui.controls.Filter=function(t,n){e.ligerui.controls.Filter.base.constructor.call(this,t,n)},e.ligerui.controls.Filter.ligerExtend(e.ligerui.core.UIComponent,{__getType:function(){return"Filter"},__idPrev:function(){return"Filter"},_init:function(){e.ligerui.controls.Filter.base._init.call(this)},_render:function(){var t=this,n=this.options;t.set(n),e("#"+t.id+" .addgroup").live("click",function(){var n=e(this).parent().parent().parent().parent();t.addGroup(n)}),e("#"+t.id+" .deletegroup").live("click",function(){var n=e(this).parent().parent().parent().parent();t.deleteGroup(n)}),e("#"+t.id+" .addrule").live("click",function(){var n=e(this).parent().parent().parent().parent();t.addRule(n)}),e("#"+t.id+" .deleterole").live("click",function(){var n=e(this).parent().parent();t.deleteRule(n)})},_setFields:function(t){var n=this,r=this.options;n.group&&n.group.remove(),n.group=e(n._bulidGroupTableHtml()).appendTo(n.element)},editors:{},editorCounter:0,addGroup:function(t){var n=this,r=this.options;t=e(t||n.group);var i=e(">tbody:first > tr:last",t),s=[];s.push('<tr class="l-filter-rowgroup"><td class="l-filter-cellgroup" colSpan="4">');var o=!t.hasClass("l-filter-group-alt");s.push(n._bulidGroupTableHtml(o,!0)),s.push("</td></tr>");var u=e(s.join(""));return i.before(u),u.find("table:first")},deleteGroup:function(t){var n=this,r=this.options;e("td.l-filter-value",t).each(function(){var t=e(this).parent();e("select.fieldsel",t).unbind(),n.removeEditor(t)}),e(t).parent().parent().remove()},removeEditor:function(t){var n=this,r=this.options,i=e(t).attr("editortype"),s=e(t).attr("editorid"),o=n.editors[s];o&&r.editors[i].destroy(o),e("td.l-filter-value:first",t).html("")},setData:function(t,n){var r=this,i=this.options;n=n||r.group;var s=e(">tbody:first > tr:last",n);n.find(">tbody:first > tr").not(s).remove(),e("select:first",s).val(t.op),t.rules&&e(t.rules).each(function(){var t=r.addRule(n);t.attr("fieldtype",this.type||"string"),e("select.opsel",t).val(this.op),e("select.fieldsel",t).val(this.field).trigger("change");var s=t.attr("editorid");if(s&&r.editors[s]){var o=r.getField(this.field);i.editors[o.editor.type].setValue(r.editors[s],this.value,o)}else e(":text",t).val(this.value)}),t.groups&&e(t.groups).each(function(){var e=r.addGroup(n);r.setData(this,e)})},addRule:function(t){var n=this,r=this.options;t=t||n.group;var i=e(">tbody:first > tr:last",t),s=e(n._bulidRuleRowHtml());return i.before(s),r.fields.length&&n.appendEditor(s,r.fields[0]),e("select.fieldsel",s).bind("change",function(){var t=e(this).parent().next().find("select:first"),r=e(this).val(),i=n.getField(r),o=i.type||"string",u=s.attr("fieldtype");o!=u&&(t.html(n._bulidOpSelectOptionsHtml(o)),s.attr("fieldtype",o));var a=null,f=s.attr("editortype");n.enabledEditor(i)&&(a=i.editor.type),f&&n.removeEditor(s),a?n.appendEditor(s,i):(s.removeAttr("editortype").removeAttr("editorid"),e("td.l-filter-value:first",s).html('<input type="text" class="valtxt" />'))}),s},deleteRule:function(t){e("select.fieldsel",t).unbind(),this.removeEditor(t),e(t).remove()},appendEditor:function(t,n){var r=this,i=this.options;if(r.enabledEditor(n)){var s=e("td.l-filter-value:first",t).html(""),o=i.editors[n.editor.type];r.editors[++r.editorCounter]=o.create(s,n),t.attr("editortype",n.editor.type).attr("editorid",r.editorCounter)}},getData:function(t){var n=this,r=this.options;t=t||n.group;var i={};return e("> tbody > tr",t).each(function(t,r){var s=e(r).hasClass("l-filter-rowlast"),o=e(r).hasClass("l-filter-rowgroup");if(o){var u=e("> td:first > table:first",r);u.length&&(i.groups||(i.groups=[]),i.groups.push(n.getData(u)))}else if(s)i.op=e(".groupopsel:first",r).val();else{var a=e("select.fieldsel:first",r).val(),f=n.getField(a),l=e(".opsel:first",r).val(),c=n._getRuleValue(r,f),h=e(r).attr("fieldtype")||"string";i.rules||(i.rules=[]),i.rules.push({field:a,op:l,value:c,type:h})}}),i},_getRuleValue:function(t,n){var r=this,i=this.options,s=e(t).attr("editorid"),o=e(t).attr("editortype"),u=r.editors[s];return u?i.editors[o].getValue(u,n):e(".valtxt:first",t).val()},enabledEditor:function(e){var t=this,n=this.options;return!e.editor||!e.editor.type?!1:e.editor.type in n.editors},getField:function(e){var t=this,n=this.options;for(var r=0,i=n.fields.length;r<i;r++){var s=n.fields[r];if(s.name==e)return s}return null},_bulidGroupTableHtml:function(e,t){var n=this,r=this.options,i=[];return i.push('<table cellpadding="0" cellspacing="0" border="0" class="l-filter-group'),e&&i.push(" l-filter-group-alt"),i.push('"><tbody>'),i.push('<tr class="l-filter-rowlast"><td class="l-filter-rowlastcell" align="right" colSpan="4">'),i.push('<select class="groupopsel">'),i.push('<option value="and">'+r.strings.and+"</option>"),i.push('<option value="or">'+r.strings.or+"</option>"),i.push("</select>"),i.push('<input type="button" value="'+r.strings.addgroup+'" class="addgroup">'),i.push('<input type="button" value="'+r.strings.addrule+'" class="addrule">'),t&&i.push('<input type="button" value="'+r.strings.deletegroup+'" class="deletegroup">'),i.push("</td></tr>"),i.push("</tbody></table>"),i.join("")},_bulidRuleRowHtml:function(e){var t=this,n=this.options;e=e||n.fields;var r=[],i=e[0].type||"string";r.push('<tr fieldtype="'+i+'"><td class="l-filter-column">'),r.push('<select class="fieldsel">');for(var s=0,o=e.length;s<o;s++){var u=e[s];r.push('<option value="'+u.name+'"'),s==0&&r.push(" selected "),r.push(">"),r.push(u.display),r.push("</option>")}return r.push("</select>"),r.push("</td>"),r.push('<td class="l-filter-op">'),r.push('<select class="opsel">'),r.push(t._bulidOpSelectOptionsHtml(i)),r.push("</select>"),r.push("</td>"),r.push('<td class="l-filter-value">'),r.push('<input type="text" class="valtxt" />'),r.push("</td>"),r.push("<td>"),r.push('<div class="l-icon-cross deleterole"></div>'),r.push("</td>"),r.push("</tr>"),r.join("")},_bulidOpSelectOptionsHtml:function(e){var t=this,n=this.options,r=n.operators[e],i=[];for(var s=0,o=r.length;s<o;s++){var u=r[s];i[i.length]='<option value="'+u+'">',i[i.length]=n.strings[u],i[i.length]="</option>"}return i.join("")}})})(jQuery)