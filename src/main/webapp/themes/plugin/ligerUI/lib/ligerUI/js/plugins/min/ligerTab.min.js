(function(e){e.fn.ligerTab=function(t){return e.ligerui.run.call(this,"ligerTab",arguments)},e.fn.ligerGetTabManager=function(){return e.ligerui.run.call(this,"ligerGetTabManager",arguments)},e.ligerDefaults.Tab={height:null,heightDiff:0,changeHeightOnResize:!1,contextmenu:!0,dblClickToClose:!1,dragToMove:!1,onBeforeOverrideTabItem:null,onAfterOverrideTabItem:null,onBeforeRemoveTabItem:null,onAfterRemoveTabItem:null,onBeforeAddTabItem:null,onAfterAddTabItem:null,onBeforeSelectTabItem:null,onAfterSelectTabItem:null},e.ligerDefaults.TabString={closeMessage:"关闭当前页",closeOtherMessage:"关闭其他",closeAllMessage:"关闭所有",reloadMessage:"刷新"},e.ligerMethos.Tab={},e.ligerui.controls.Tab=function(t,n){e.ligerui.controls.Tab.base.constructor.call(this,t,n)},e.ligerui.controls.Tab.ligerExtend(e.ligerui.core.UIComponent,{__getType:function(){return"Tab"},__idPrev:function(){return"Tab"},_extendMethods:function(){return e.ligerMethos.Tab},_render:function(){var t=this,n=this.options;n.height&&(t.makeFullHeight=!0),t.tab=e(this.element),t.tab.addClass("l-tab"),n.contextmenu&&e.ligerMenu&&(t.tab.menu=e.ligerMenu({width:100,items:[{text:n.closeMessage,id:"close",click:function(){t._menuItemClick.apply(t,arguments)}},{text:n.closeOtherMessage,id:"closeother",click:function(){t._menuItemClick.apply(t,arguments)}},{text:n.closeAllMessage,id:"closeall",click:function(){t._menuItemClick.apply(t,arguments)}},{text:n.reloadMessage,id:"reload",click:function(){t._menuItemClick.apply(t,arguments)}}]})),t.tab.content=e('<div class="l-tab-content"></div>'),e("> div",t.tab).appendTo(t.tab.content),t.tab.content.appendTo(t.tab),t.tab.links=e('<div class="l-tab-links"><ul style="left: 0px; "></ul></div>'),t.tab.links.prependTo(t.tab),t.tab.links.ul=e("ul",t.tab.links);var r=e("> div[lselected=true]",t.tab.content),i=r.length>0;t.selectedTabId=r.attr("tabid"),e("> div",t.tab.content).each(function(n,r){var s=e('<li class=""><a></a><div class="l-tab-links-item-left"></div><div class="l-tab-links-item-right"></div></li>'),o=e(this);o.attr("title")&&(e("> a",s).html(o.attr("title")),o.attr("title",""));var u=o.attr("tabid");u==undefined&&(u=t.getNewTabid(),o.attr("tabid",u),o.attr("lselected")&&(t.selectedTabId=u)),s.attr("tabid",u),!i&&n==0&&(t.selectedTabId=u);var a=o.attr("showClose");a&&s.append("<div class='l-tab-links-item-close'></div>"),e("> ul",t.tab.links).append(s),o.hasClass("l-tab-content-item")||o.addClass("l-tab-content-item");if(o.find("iframe").length>0){var f=e("iframe:first",o);if(f[0].readyState!="complete"){o.find(".l-tab-loading:first").length==0&&o.prepend("<div class='l-tab-loading' style='display:block;'></div>");var l=e(".l-tab-loading:first",o);f.bind("load.tab",function(){l.hide()})}}}),t.selectTabItem(t.selectedTabId),n.height&&(typeof n.height=="string"&&n.height.indexOf("%")>0?(t.onResize(),n.changeHeightOnResize&&e(window).resize(function(){t.onResize.call(t)})):t.setHeight(n.height)),t.makeFullHeight&&t.setContentHeight(),e("li",t.tab.links).each(function(){t._addTabItemEvent(e(this))}),t.tab.bind("dblclick.tab",function(r){if(!n.dblClickToClose)return;t.dblclicking=!0;var i=r.target||r.srcElement,s=i.tagName.toLowerCase();if(s=="a"){var o=e(i).parent().attr("tabid"),u=e(i).parent().find("div.l-tab-links-item-close").length?!0:!1;u&&t.removeTabItem(o)}t.dblclicking=!1}),t.set(n)},_applyDrag:function(t){var n=this,r=this.options;n.droptip=n.droptip||e("<div class='l-tab-drag-droptip' style='display:none'><div class='l-drop-move-up'></div><div class='l-drop-move-down'></div></div>").appendTo("body");var i=e(t).ligerDrag({revert:!0,animate:!1,proxy:function(){var t=e(this).find("a").html();return n.dragproxy=e("<div class='l-tab-drag-proxy' style='display:none'><div class='l-drop-icon l-drop-no'></div></div>").appendTo("body"),n.dragproxy.append(t),n.dragproxy},onRendered:function(){this.set("cursor","pointer")},onStartDrag:function(n,r){if(!e(t).hasClass("l-selected"))return!1;if(r.button==2)return!1;var i=r.srcElement||r.target;if(e(i).hasClass("l-tab-links-item-close"))return!1},onDrag:function(t,r){n.dropIn==null&&(n.dropIn=-1);var i=n.tab.links.ul.find(">li"),s=i.index(t.target);i.each(function(t,i){if(s==t)return;var o=t>s;if(n.dropIn!=-1&&n.dropIn!=t)return;var u=e(this).offset(),a={top:u.top,bottom:u.top+e(this).height(),left:u.left-10,right:u.left+10};o&&(a.left+=e(this).width(),a.right+=e(this).width());var f=r.pageX||r.screenX,l=r.pageY||r.screenY;f>a.left&&f<a.right&&l>a.top&&l<a.bottom?(n.droptip.css({left:a.left+5,top:a.top-9}).show(),n.dropIn=t,n.dragproxy.find(".l-drop-icon").removeClass("l-drop-no").addClass("l-drop-yes")):(n.dropIn=-1,n.droptip.hide(),n.dragproxy.find(".l-drop-icon").removeClass("l-drop-yes").addClass("l-drop-no"))})},onStopDrag:function(t,r){if(n.dropIn>-1){var i=n.tab.links.ul.find(">li:eq("+n.dropIn+")").attr("tabid"),s=e(t.target).attr("tabid");setTimeout(function(){n.moveTabItem(s,i)},0),n.dropIn=-1,n.dragproxy.remove()}n.droptip.hide(),this.set("cursor","default")}});return i},_setDragToMove:function(t){if(!e.fn.ligerDrag)return;var n=this,r=this.options;if(t){if(n.drags)return;n.drags=n.drags||[],n.tab.links.ul.find(">li").each(function(){n.drags.push(n._applyDrag(this))})}},moveTabItem:function(e,t){var n=this,r=n.tab.links.ul.find(">li[tabid="+e+"]"),i=n.tab.links.ul.find(">li[tabid="+t+"]"),s=n.tab.links.ul.find(">li").index(r),o=n.tab.links.ul.find(">li").index(i);s<o?i.after(r):i.before(r)},setTabButton:function(){var t=this,n=this.options,r=0;e("li",t.tab.links.ul).each(function(){r+=e(this).width()+2});var i=t.tab.width();return r>i?(t.tab.links.append('<div class="l-tab-links-left"></div><div class="l-tab-links-right"></div>'),t.setTabButtonEven(),!0):(t.tab.links.ul.animate({left:0}),e(".l-tab-links-left,.l-tab-links-right",t.tab.links).remove(),!1)},setTabButtonEven:function(){var t=this,n=this.options;e(".l-tab-links-left",t.tab.links).hover(function(){e(this).addClass("l-tab-links-left-over")},function(){e(this).removeClass("l-tab-links-left-over")}).click(function(){t.moveToPrevTabItem()}),e(".l-tab-links-right",t.tab.links).hover(function(){e(this).addClass("l-tab-links-right-over")},function(){e(this).removeClass("l-tab-links-right-over")}).click(function(){t.moveToNextTabItem()})},moveToPrevTabItem:function(){var t=this,n=this.options,r=e(".l-tab-links-left",t.tab.links).width(),i=new Array;e("li",t.tab.links).each(function(t,n){var s=-1*r;t>0&&(s=parseInt(i[t-1])+e(this).prev().width()+2),i.push(s)});var s=-1*parseInt(t.tab.links.ul.css("left"));for(var o=0;o<i.length-1;o++)if(i[o]<s&&i[o+1]>=s){t.tab.links.ul.animate({left:-1*parseInt(i[o])});return}},moveToNextTabItem:function(){var t=this,n=this.options,r=e(".l-tab-links-right",t.tab).width(),i=0,s=e("li",t.tab.links.ul);s.each(function(){i+=e(this).width()+2});var o=t.tab.width(),u=new Array;for(var a=s.length-1;a>=0;a--){var f=i-o+r+2;a!=s.length-1&&(f=parseInt(u[s.length-2-a])-e(s[a+1]).width()-2),u.push(f)}var l=-1*parseInt(t.tab.links.ul.css("left"));for(var c=1;c<u.length;c++)if(u[c]<=l&&u[c-1]>l){t.tab.links.ul.animate({left:-1*parseInt(u[c-1])});return}},getTabItemCount:function(){var t=this,n=this.options;return e("li",t.tab.links.ul).length},getSelectedTabItemID:function(){var t=this,n=this.options;return e("li.l-selected",t.tab.links.ul).attr("tabid")},removeSelectedTabItem:function(){var e=this,t=this.options;e.removeTabItem(e.getSelectedTabItemID())},overrideSelectedTabItem:function(e){var t=this,n=this.options;t.overrideTabItem(t.getSelectedTabItemID(),e)},overrideTabItem:function(t,n){var r=this,i=this.options;if(r.trigger("beforeOverrideTabItem",[t])==0)return!1;var s=n.tabid;s==undefined&&(s=r.getNewTabid());var o=n.url,u=n.content,a=n.target,f=n.text,l=n.showClose,c=n.height;if(r.isTabItemExist(s))return;var h=e("li[tabid="+t+"]",r.tab.links.ul),p=e(".l-tab-content-item[tabid="+t+"]",r.tab.content);if(!h||!p)return;h.attr("tabid",s),p.attr("tabid",s),e("iframe",p).length==0&&o?p.html("<iframe frameborder='0'></iframe>"):u&&p.html(u),e("iframe",p).attr("name",s),l==undefined&&(l=!0),l==0?e(".l-tab-links-item-close",h).remove():e(".l-tab-links-item-close",h).length==0&&h.append("<div class='l-tab-links-item-close'></div>"),f==undefined&&(f=s),c&&p.height(c),e("a",h).text(f),e("iframe",p).attr("src",o),r.trigger("afterOverrideTabItem",[t])},selectTabItem:function(t){var n=this,r=this.options;if(n.trigger("beforeSelectTabItem",[t])==0)return!1;n.selectedTabId=t,e("> .l-tab-content-item[tabid="+t+"]",n.tab.content).show().siblings().hide(),e("li[tabid="+t+"]",n.tab.links.ul).addClass("l-selected").siblings().removeClass("l-selected"),n.trigger("afterSelectTabItem",[t])},moveToLastTabItem:function(){var t=this,n=this.options,r=0;e("li",t.tab.links.ul).each(function(){r+=e(this).width()+2});var i=t.tab.width();if(r>i){var s=e(".l-tab-links-right",t.tab.links).width();t.tab.links.ul.animate({left:-1*(r-i+s+2)})}},isTabItemExist:function(t){var n=this,r=this.options;return e("li[tabid="+t+"]",n.tab.links.ul).length>0},addTabItem:function(t){var n=this,r=this.options;if(n.trigger("beforeAddTabItem",[i])==0)return!1;var i=t.tabid;i==undefined&&(i=n.getNewTabid());var s=t.url,o=t.content,u=t.text,a=t.showClose,f=t.height;if(n.isTabItemExist(i)){n.selectTabItem(i);return}var l=e("<li><a></a><div class='l-tab-links-item-left'></div><div class='l-tab-links-item-right'></div><div class='l-tab-links-item-close'></div></li>"),c=e("<div class='l-tab-content-item'><div class='l-tab-loading' style='display:block;'></div><iframe frameborder='0'></iframe></div>"),h=e("div:first",c),p=e("iframe:first",c);if(n.makeFullHeight){var d=n.tab.height()-n.tab.links.height();c.height(d)}l.attr("tabid",i),c.attr("tabid",i),s?p.attr("name",i).attr("id",i).attr("src",s).bind("load.tab",function(){h.hide(),t.callback&&t.callback()}):(p.remove(),h.remove()),o?c.html(o):t.target&&c.append(t.target),a==undefined&&(a=!0),a==0&&e(".l-tab-links-item-close",l).remove(),u==undefined&&(u=i),f&&c.height(f),e("a",l).text(u),n.tab.links.ul.append(l),n.tab.content.append(c),n.selectTabItem(i),n.setTabButton()&&n.moveToLastTabItem(),n._addTabItemEvent(l),r.dragToMove&&e.fn.ligerDrag&&(n.drags=n.drags||[],l.each(function(){n.drags.push(n._applyDrag(this))})),n.trigger("afterAddTabItem",[i])},_addTabItemEvent:function(t){var n=this,r=this.options;t.click(function(){var t=e(this).attr("tabid");n.selectTabItem(t)}),n.tab.menu&&n._addTabItemContextMenuEven(t),e(".l-tab-links-item-close",t).hover(function(){e(this).addClass("l-tab-links-item-close-over")},function(){e(this).removeClass("l-tab-links-item-close-over")}).click(function(){var t=e(this).parent().attr("tabid");n.removeTabItem(t)})},removeTabItem:function(t){var n=this,r=this.options;if(n.trigger("beforeRemoveTabItem",[t])==0)return!1;var i=e("li[tabid="+t+"]",n.tab.links.ul).hasClass("l-selected");i&&(e(".l-tab-content-item[tabid="+t+"]",n.tab.content).prev().show(),e("li[tabid="+t+"]",n.tab.links.ul).prev().addClass("l-selected").siblings().removeClass("l-selected")),e(".l-tab-content-item[tabid="+t+"]",n.tab.content).remove(),e("li[tabid="+t+"]",n.tab.links.ul).remove(),n.setTabButton(),n.trigger("afterRemoveTabItem",[t])},addHeight:function(e){var t=this,n=this.options,r=t.tab.height()+e;t.setHeight(r)},setHeight:function(e){var t=this,n=this.options;t.tab.height(e),t.setContentHeight()},setContentHeight:function(){var t=this,n=this.options,r=t.tab.height()-t.tab.links.height();t.tab.content.height(r),e("> .l-tab-content-item",t.tab.content).height(r)},getNewTabid:function(){var e=this,t=this.options;return e.getnewidcount=e.getnewidcount||0,"tabitem"+ ++e.getnewidcount},getTabidList:function(t,n){var r=this,i=this.options,s=[];return e("> li",r.tab.links.ul).each(function(){e(this).attr("tabid")&&e(this).attr("tabid")!=t&&(!n||e(".l-tab-links-item-close",this).length>0)&&s.push(e(this).attr("tabid"))}),s},removeOther:function(t,n){var r=this,i=this.options,s=r.getTabidList(t,!0);e(s).each(function(){r.removeTabItem(this)})},reload:function(t){var n=this,r=this.options,i=e(".l-tab-content-item[tabid="+t+"]"),s=e(".l-tab-loading:first",i),o=e("iframe:first",i),u=e(o).attr("src");s.show(),o.attr("src",u).unbind("load.tab").bind("load.tab",function(){s.hide()})},removeAll:function(t){var n=this,r=this.options,i=n.getTabidList(null,!0);e(i).each(function(){n.removeTabItem(this)})},onResize:function(){var t=this,n=this.options;if(!n.height||typeof n.height!="string"||n.height.indexOf("%")==-1)return!1;if(t.tab.parent()[0].tagName.toLowerCase()=="body"){var r=e(window).height();r-=parseInt(t.tab.parent().css("paddingTop")),r-=parseInt(t.tab.parent().css("paddingBottom")),t.height=n.heightDiff+r*parseFloat(t.height)*.01}else t.height=n.heightDiff+t.tab.parent().height()*parseFloat(n.height)*.01;t.tab.height(t.height),t.setContentHeight()},_menuItemClick:function(e){var t=this,n=this.options;if(!e.id||!t.actionTabid)return;switch(e.id){case"close":t.removeTabItem(t.actionTabid),t.actionTabid=null;break;case"closeother":t.removeOther(t.actionTabid);break;case"closeall":t.removeAll(),t.actionTabid=null;break;case"reload":t.selectTabItem(t.actionTabid),t.reload(t.actionTabid)}},_addTabItemContextMenuEven:function(t){var n=this,r=this.options;t.bind("contextmenu",function(r){if(!n.tab.menu)return;return n.actionTabid=t.attr("tabid"),n.tab.menu.show({top:r.pageY,left:r.pageX}),e(".l-tab-links-item-close",this).length==0?n.tab.menu.setDisabled("close"):n.tab.menu.setEnabled("close"),!1})}})})(jQuery)